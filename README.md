# ASR字准确率对比工具

这是一个用于批量对比ASR（自动语音识别）转写结果与标准文本之间字准确率的Python工具。

## 功能特性

- 批量导入ASR转写结果文档和标准标注文档
- 通过拖拽方式建立ASR结果和标注文件的一一对应关系
- 自动计算字准确率（Character Accuracy Rate）
- 统计文档字数信息
- 支持导出统计结果为TXT或CSV格式
- 支持多种文本编码（UTF-8、GBK、GB2312、GB18030、ANSI）
- 提供800x600的默认窗口大小，支持窗口最大化
- **新增：基于jieba分词的中文文本预处理**
- **新增：精确的中文字符位置定位和错误分析**
- **新增：中文文本标准化处理（全/半角转换、数字统一等）**
- **新增：语气词过滤功能，可选择是否将"嗯"、"啊"等语气词计入CER计算**
- **新增：优化的用户界面布局，更大的结果展示区域**

## 安装依赖

使用pip安装依赖：

```bash
pip install -r requirements.txt
```

主要依赖：
- jiwer>=2.5.0：用于计算字/词错误率
- pandas>=1.3.5：用于数据处理和导出
- tk>=0.1.0：提供GUI界面支持
- **jieba>=0.42.1：中文分词库**
- **python-Levenshtein>=0.12.2：计算编辑距离**

## 使用方法

本工具提供三种不同的使用方式：

### 1. GUI界面方式（推荐）

```bash
python src/main.py
```

使用步骤：
1. 在界面左侧点击"选择ASR文件"按钮，批量导入ASR转写结果文件
2. 在界面右侧点击"选择标注文件"按钮，批量导入标准标注文件
3. 如有需要，通过拖拽调整文件顺序建立对应关系
4. 根据需要勾选"语气词过滤"选项（鼠标悬停在"?"上可查看详细说明）
5. 点击"开始统计"按钮，计算字准确率
6. 查看结果表格，包含文件名、字数、准确率和过滤状态信息
7. 点击"导出结果"按钮，将结果保存为TXT或CSV文件

### 2. 示例测试方式

运行内置示例，查看字准确率计算功能：

```bash
python example_test.py
```

这会展示：
- 中文文本的字准确率计算示例
- 英文文本的字准确率计算示例
- 从文件读取文本并计算字准确率的示例
- **新增：复杂中文文本的字准确率计算示例**
- **新增：语气词过滤功能演示**

### 3. 命令行工具方式

直接比较两个指定的文件：

```bash
python check_accuracy.py --ref 参考文件路径 --asr ASR结果文件路径 [选项]
```

可用选项：
- `--details`：显示详细的错误分析，包括错误高亮和字符位置信息
- `--no-jieba`：提示不使用jieba分词（当前版本中此选项仅作为提示）
- `--filter-fillers`：过滤语气词（如"嗯"、"啊"、"呢"等），不将其计入CER计算

例如：
```bash
# 基本用法
python check_accuracy.py --ref ref_text1.txt --asr asr_result1.txt

# 显示详细错误分析
python check_accuracy.py --ref ref_text1.txt --asr asr_result1.txt --details

# 过滤语气词计算CER
python check_accuracy.py --ref ref_text1.txt --asr asr_result1.txt --filter-fillers
```

命令行工具会显示详细的评估结果，包括字准确率、错误率、替换/删除/插入错误数等指标。

## 字准确率计算方法

工具使用的是字符错误率（CER）的补集，计算公式为：

```
字准确率 = 1 - CER = 1 - (S + D + I) / N
```

其中：
- S：替换错误数
- D：删除错误数
- I：插入错误数
- N：标准文本中的字符总数

**改进的中文字准确率计算流程：**

1. **分词预处理**：使用jieba对中文文本进行分词，提高对中文语义的理解
2. **文本标准化**：处理全/半角字符、统一数字表达、移除标点符号等
3. **语气词过滤（可选）**：过滤"嗯"、"啊"、"呢"等语气词，使CER更准确反映实际语义
4. **字符位置定位**：使用jieba.tokenize获取每个字符在原文中的精确位置
5. **编辑距离计算**：使用Levenshtein距离算法计算字符级别的编辑距离
6. **错误分析与高亮**：识别替换、删除、插入错误，并提供可视化的错误高亮

## 界面布局优化

最新版本对界面布局进行了优化：

1. **紧凑的文件选择区域**：减小了文件列表显示区域的高度，使上半部分更紧凑
2. **增大的结果展示区域**：下方的结果展示表格行数从8行增加到12行，以展示更多结果
3. **改进的控制区域**：将"开始统计"按钮和"语气词过滤"勾选框放在同一行，布局更合理
4. **语气词过滤功能提示**：添加了悬停提示，方便用户了解功能作用
5. **智能的布局分配**：上部分区域固定大小，下部分结果区域可随窗口调整自动扩展

## 项目结构

- `src/main.py`：主程序，包含GUI界面和主要功能
- `src/utils.py`：工具类，包含字准确率计算相关函数
- `example_test.py`：示例测试脚本
- `check_accuracy.py`：命令行比较工具
- `requirements.txt`：项目依赖列表
- `docs/UI-definition.md`：用户界面定义文档

## 注意事项

- 支持的文件格式：纯文本文件(.txt)
- 文件编码：支持UTF-8、GBK、GB2312、GB18030及系统默认编码（ANSI）
- 字准确率计算是基于字符级别的，特别适合中文等没有明确词边界的语言
- **jieba分词初次加载时可能需要几秒钟时间构建词典缓存**
- **对于专业领域文本，可考虑通过jieba.load_userdict()添加自定义词典**
- **语气词过滤功能默认识别常见的20种中文语气词，也会基于jieba的词性标注识别"语气词(y)"** 